<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            Jni ，从入门到入坟 | 
        
        Albert&#39;s Blog
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Albert Humbert">
    <meta name="description" itemprop="description" content="developing">
    <meta name="keywords" content="null,notes">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Albert&#39;s Blog">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://alberthumbert.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Jni ，从入门到入坟 | Albert&#39;s Blog">
    <meta property="og:image" content="/img/favicon.png" />
    <meta property="og:description" content="developing">
    <meta property="og:article:tag" content="notes"> 

    
        <meta property="article:published_time" content="11月 17, 2017" />
        <meta property="article:modified_time" content="11月 22, 2017" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="Jni ，从入门到入坟 | Albert&#39;s Blog">
    <meta name="twitter:description" content="developing">
    <meta name="twitter:image" content="/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://alberthumbert.github.io" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="https://alberthumbert.github.io/2017/11/17/Jni/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Albert&#39;s Blog",
        "logo": "/img/favicon.png"
    },
    "author": {
        "@type": "Person",
        "name": "Albert Humbert",
        "image": {
            "@type": "ImageObject",
            "url": "/img/favicon.png"
        },
        "description": "Paranoid Android"
    },
    "headline": "Jni ，从入门到入坟",
    "url": "https://alberthumbert.github.io/2017/11/17/Jni/index.html",
    "datePublished": "11月 17, 2017",
    "dateModified": "11月 22, 2017",
    "description": "developing",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://alberthumbert.github.io"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    .footer-sns-facebook {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHptNjU3LjYgODcuOGw0LjggMy44djU1LjJjMCA1NC42IDAgNTUuMi00LjYgNTkuNi00LjQgNC40LTYgNC42LTUwLjIgNS42bC00NS42IDEtNy4yIDUuNmMtMTAuNCA4LTE2LjggMTcuMi0xOS4yIDI3LjQtMSA1LTEuOCAyNC44LTEuOCA0NCAuMiAzOCAxLjYgNDQuNiAxMC44IDQ4IDIuOCAxLjIgMjguNCAyIDU2LjggMiA0Ny44IDAgNTIgLjIgNTYuMiAzLjhsNC44IDMuOHY1NS4yYzAgNTQuNiAwIDU1LjItNC42IDU5LjYtNC40IDQuNi01LjQgNC42LTU3IDUuMi0yOC44LjItNTQuNC44LTU2LjggMS40LTIuNC42LTUuNiAzLTYuOCA1LjQtMS44IDMuMi0yLjQgNDEuNC0yLjYgMTQzLjJsLS4yIDEzOC44LTUuNiA0LjgtNS42IDQuOEg2MDljLTUyLjQgMC01Mi44IDAtNTguMi00LjZsLTUuNC00LjYtLjItMTQwLjYtLjItMTQwLjYtNC44LTMuOGMtNC4yLTMuNC04LTMuOC0zNS42LTMuOC0zMi44IDAtNDEtMS44LTQzLjYtMTAtLjYtMi4yLTEuMi0yNS40LTEuMi01MS40IDAtNjAuOC0uMi01NyAzLjQtNjEuNiAyLjgtMy42IDYtNCAzNy44LTUgMzMtMSAzNS4yLTEuMiAzOS40LTUuNiA0LjYtNC40IDQuNi01LjIgNS44LTcxIDEuMi03My40LjItNjcuMiAxNi42LTk5LjQgOC0xNS44IDEyLjgtMjIgMjgtMzcgMTUuMi0xNS4yIDIxLjQtMTkuNiAzOC4yLTI4IDExLTUuNCAyNC0xMSAyOS0xMi4yIDYuMi0xLjggMjguNi0yLjYgNzEuMi0yLjYgNTguNi0uMiA2Mi42IDAgNjcgMy42eiIvPjwvc3ZnPg==);
    }
    
    
    .footer-sns-twitter {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHptNTMyLjggMjA1YzEwIDQgMjMgMTAuOCAyOC44IDE1LjIgMTIuNiA5LjIgMTYuNiAxMC42IDI5LjQgOS40IDYuNi0uNiAxMy0zLjIgMjAuNC04LjIgMTEuMi03LjYgMTkuNC05LjIgMjMuNi01IDMuNiAzLjYgMi44IDktMi44IDE4LjYtNy4yIDEyLjQtNiAxOC44IDQuMiAyNC4yIDQuNCAyLjIgOC4yIDUuNiA4LjYgNy40IDEgNC44LTEyLjYgMjQuMi0yMiAzMS44LTExLjggOS4yLTE3LjIgMjIuNi0xOS42IDQ3LjgtNC44IDUwLjQtNy44IDY2LjYtMTYuNCA4NS40LTMgNy03IDE3LjgtOC44IDI0LTEuOCA2LjQtNSAxNC42LTcuNCAxOC40LTIuMiAzLjgtNy40IDEzLTExLjQgMjAuNC0xNy4yIDMwLjgtNDMuNCA2MS40LTcxLjQgODMuOC0yNS42IDIwLjQtNDYgMzMuMi02NC4yIDQwLjItOC40IDMuMi0xOCA3LjYtMjEuNCA5LjYtNy40IDQuNi0yMi40IDguNi01Ny4yIDE1LTYyLjIgMTEuNi03OS4yIDExLjQtMTM1LjYtMS0zMi40LTctMzguNi05LTUyLTE2LjgtMjEuNC0xMi42LTI0LjItMTQuOC0yNC4yLTE5LjQgMC02LjIgMTAuMi05LjIgMzUtMTAuNCAyMi40LTEgMjguNi0yLjYgNTctMTQuMiAyMy44LTkuOCAyOS40LTEyLjggMzAuNC0xNi44IDIuMi04LjItMy0xMy4yLTI2LjgtMjUuNC0yNS44LTEzLjItMzIuMi0xOC40LTQzLjgtMzUuOC05LTEzLjYtMTAtMjEuMi0zLjYtMzMuNiA1LjQtMTAuOCAzLjYtMTUtMTEuOC0yNS40LTktNi0xNC0xMS42LTIwLjgtMjIuNi0yMy40LTM3LjgtMjUtNTAuOC03LjItNTkuOCA0LjgtMi40IDkuNC01LjQgMTAuMi02LjYgMi44LTQuMi0uNC0xNS42LTguNC0yOS0xMS42LTE5LjYtMTMuMi0yNS44LTEzLjItNTUuMiAwLTI4LjggMi42LTM3LjggMTItNDAuMiA5LTIuMiAxNC44IDEgMzUuNiAyMC4yIDI0LjggMjIuOCA0My42IDM2LjYgNjIuOCA0NS44IDggMy44IDE3LjggOS4yIDIyIDEyIDQuMiAyLjggMTQuOCA3IDIzLjQgOS4yIDguNiAyLjIgMjQuMiA2LjggMzQuOCAxMC4yIDEzLjQgNC40IDIzLjYgNi40IDMzIDYuNiAxMi44LjIgMTQuMi0uMiAxOC42LTUuNCA0LTQuOCA0LjgtNy44IDQuOC0xOS4yIDAtMTQuNCA1LjYtMzkuNiAxMS4yLTUwLjYgNC4yLTguNCAyOS4yLTM0LjIgMzkuOC00MS40IDcuOC01LjQgMzUuNi0xNiA1Mi0yMCAxNC4yLTMuNiAzMi42LTEuMiA1Mi40IDYuOHoiLz48L3N2Zz4=);
    }
    
    
    .footer-sns-gplus {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHpNNDMwIDI5NS40YzQwLjYgMTUuNCA1Ni42IDIzLjggNzIuNiAzOC40IDYuOCA2LjIgNy4yIDE1LjIgMSAyMy40LTYuMiA4LTMzLjYgMzMuOC0zOSAzNi42LTUuNiAyLjgtMTcuNiAyLjgtMjMuMi0uMi0yLjQtMS4yLTguMi01LjItMTMtOC44LTExLjItOC42LTI0LjYtMTEuMi01NS4yLTExLjItMjcuNCAwLTQwLjYgMi42LTUyLjIgMTAuNC00LjQgMi44LTEyLjIgNy42LTE3LjIgMTAuNi0yMyAxMy4yLTUxLjQgNTUtNTUuOCA4Mi40LTIuNiAxNS42LTIuNCAzNC44LjIgNTEgMi44IDE3LjQgMTkuOCA0OC44IDM1LjIgNjUuMiAxNiAxNi42IDQ1IDMzLjYgNjIuOCAzNi42IDI2LjggNC40IDY1LjggMS42IDc5LjQtNS44IDIwLjYtMTEuNCAzMS0xOSA0MS0zMC40IDE4LjgtMjEuNiAyMy40LTM0LjIgMTUuNi00My44LTMuOC00LjgtNC40LTQuOC01MS01LjgtNjAuOC0xLjItNTYuMiAyLjItNTYuMi00My4yIDAtMzIuNC4yLTMzLjIgNC44LTM3IDQuNC0zLjYgOS0zLjggOTItMy44IDc5IDAgODcuOC40IDk0LjIgMy42IDExLjIgNS42IDEzIDExLjQgMTIuOCA0My40IDAgMjUuNC0uOCAzMC44LTcuNiA1OC00IDE2LjYtOS44IDM0LTEyLjYgMzktMi44IDUtOC4yIDE0LjItMTEuNiAyMC42LTguNCAxNS40LTI3LjIgMzYuOC00MC44IDQ2LjYtNS44IDQuNC0xMy44IDEwLjItMTcuNiAxMy4yLTMuOCAzLTExIDctMTYuMiA4LjgtNS4yIDEuOC0xNi4yIDYuNC0yNC40IDEwLTIyLjQgOS42LTM0LjggMTEuNi03MyAxMS42LTM3LjYuMi00Ny0xLjQtNzEtMTItOC4yLTMuNi0xNy42LTcuMi0yMC44LTgtMTUuOC0zLjgtNjctNDUuMi03Ny44LTYyLjgtMi4yLTMuOC03LjYtMTEuNi0xMS44LTE3LjItNC4yLTUuNC05LTE0LTEwLjYtMTktMS44LTQuOC02LjItMTYtMTAtMjQuOC0zLjYtOC44LTcuOC0yMi4yLTkuMi0yOS42LTMuMi0xOC44LTEuNC03OS40IDIuOC05MS40IDEzLjgtNDAuNiAzNS42LTc4IDU4LjgtMTAwLjIgMTQtMTMuNiA0Ny4yLTM2LjQgNTgtMzkuOCA0LjItMS40IDEzLjQtNS4yIDIwLjYtOC40IDIyLTEwIDMyLjgtMTEuNiA3Ni0xMSAzMy44LjYgNDAuNCAxLjIgNTAgNC44em0zNDAuOCA4MC44YzggMy42IDkuNiAxMS4yIDkuMiAzOS4yLS42IDM0LjQtLjYgMzQgNSAzOS42IDQuOCA1IDUuNCA1IDM3LjYgNSA0My40IDAgNDQuNC44IDQzLjIgMzYuMi0uOCAxNy0xLjIgMTguNC02LjQgMjMtNS40IDQuNi02LjYgNC44LTM3LjYgNC44LTMxLjIgMC0zMiAuMi0zNi44IDUtNS42IDUuNC01LjYgNC40LTUgNDEuMi40IDI2LjQuMiAyNy40LTQuNiAzMy00LjggNS42LTYgNS44LTI0LjQgNi40LTIwLjguOC0yOS42LTEuNC0zMy40LTguNC0xLjQtMi42LTItMTUuNi0xLjgtMzUuNi40LTMxLjIuNC0zMS42LTQuNi0zNi42cy01LjYtNS0zNi01Yy0xOC44IDAtMzMtLjgtMzYtMi4yLTcuNi0zLjYtOS42LTExLjItOC44LTMzLjguOC0yOC4yLjQtMjggNDEtMjggNDUuNCAwIDQ1LjQgMCA0NC42LTQyLjYtLjYtMzMtLjYtMzMgNS0zOC40IDQuNC00LjYgNi4yLTUgMjQuOC01IDExIDAgMjIuMiAxIDI1IDIuMnoiLz48L3N2Zz4=);
    }
    
    
    
    
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#如何使用jni进行开发"><span class="post-toc-number">1.</span> <span class="post-toc-text">如何使用jni进行开发</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AS-2-2之前的做法"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">AS 2.2之前的做法</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-编写C-C"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">1.编写C/C++</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-使用ndk编译so包"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">2.使用ndk编译so包</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#包结构"><span class="post-toc-number">1.1.2.1.</span> <span class="post-toc-text">包结构</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#编写Android-mk"><span class="post-toc-number">1.1.2.2.</span> <span class="post-toc-text">编写Android.mk</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#编写Application-mk"><span class="post-toc-number">1.1.2.3.</span> <span class="post-toc-text">编写Application.mk</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#人生苦短，我用AS-3-0"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">人生苦短，我用AS 3.0</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#自动生成函数"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">自动生成函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#编写CMakeList"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">编写CMakeList</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用g-编译so包"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">使用g++编译so包</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ABI与so"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">ABI与so</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#什么是jni"><span class="post-toc-number">2.</span> <span class="post-toc-text">什么是jni</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#jni-h"><span class="post-toc-number">3.</span> <span class="post-toc-text">jni.h</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#jni数据类型"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">jni数据类型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#常用的接口"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">常用的接口</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#修改成员变量"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">修改成员变量</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建引用"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">创建引用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#引用类型"><span class="post-toc-number">3.2.2.1.</span> <span class="post-toc-text">引用类型</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#局部引用"><span class="post-toc-number">3.2.2.2.</span> <span class="post-toc-text">局部引用</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#全局引用"><span class="post-toc-number">3.2.2.3.</span> <span class="post-toc-text">全局引用</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#弱引用"><span class="post-toc-number">3.2.2.4.</span> <span class="post-toc-text">弱引用</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#JNIEnv，JavaVM-以及多线程"><span class="post-toc-number">3.2.3.</span> <span class="post-toc-text">JNIEnv，JavaVM 以及多线程</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#内存泄漏"><span class="post-toc-number">4.</span> <span class="post-toc-text">内存泄漏</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#局部引用的内存模型"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">局部引用的内存模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#引用的使用规范"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">引用的使用规范</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#推荐阅读"><span class="post-toc-number">5.</span> <span class="post-toc-text">推荐阅读</span></a></li></ol>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                Jni ，从入门到入坟
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Albert Humbert</strong>
        <span>11月 17, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/notes/">notes</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Jni ，从入门到入坟&url=https://alberthumbert.github.io/2017/11/17/Jni/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Jni ，从入门到入坟&url=https://alberthumbert.github.io/2017/11/17/Jni/index.html&via=Albert Humbert" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=https://alberthumbert.github.io/2017/11/17/Jni/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=https://alberthumbert.github.io/2017/11/17/Jni/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    
        <a class="post_share-link" href="https://www.linkedin.com/shareArticle?mini=true&url=https://alberthumbert.github.io/2017/11/17/Jni/index.html&title=Jni ，从入门到入坟" target="_blank">
            <li class="mdl-menu__item">
                分享到 LinkedIn
            </li>
        </a>
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Albert&#39;s Blog&title=Jni ，从入门到入坟&summary=developing&pics=https://alberthumbert.github.io/img/favicon.png&url=https://alberthumbert.github.io/2017/11/17/Jni/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
        <a class="post_share-link" href="https://telegram.me/share/url?url=https://alberthumbert.github.io/2017/11/17/Jni/index.html&text=Jni ，从入门到入坟" target="_blank">
            <li class="mdl-menu__item">
                分享到 Telegram
            </li>
        </a>
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <a id="more"></a>
<p><br></p>
<h2 id="如何使用jni进行开发"><a href="#如何使用jni进行开发" class="headerlink" title="如何使用jni进行开发"></a>如何使用jni进行开发</h2><p><strong>本文主要针对Android环境进行NDK\Native\Jni开发进行介绍</strong></p>
<p><strong>使用2.2版本之前的Android Studio进行ndk开发是比较繁琐的，如果你还在使用旧版本的Android Studio，那么建议更新到3.0，现阶段3.0已经比较稳定了(虽然旧项目的gradle升级可能需要折腾一下)。下面介绍旧版本的开发流程只是为了能够更加详细地介绍jni。</strong></p>
<p><strong>jni并不是android框架内的概念，所以也会提及其他环境使用jni开发的方法，基本上大同小异，不过你可能还需要查阅其他文章来处理一些细节问题（如Windows下生成dll文件）</strong></p>
<p><br></p>
<h3 id="AS-2-2之前的做法"><a href="#AS-2-2之前的做法" class="headerlink" title="AS 2.2之前的做法"></a>AS 2.2之前的做法</h3><p><br></p>
<h4 id="1-编写C-C"><a href="#1-编写C-C" class="headerlink" title="1.编写C/C++"></a>1.编写C/C++</h4><ul>
<li>首先创建一个java文件，声明一个自定义的native方法，对我们来说，这个方法就是java层到native层的入口，另外，还需要使用静态域将so包加载进来</li>
</ul>
<pre><code>package com.linjiamin.jnishare;

/**
* Created by Albert on 17/11/16.
*/

public class JniUtil {

    static {
        System.loadLibrary(&quot;sotest&quot;);
    }

    public static native int sum(int num1,int num2);
}
</code></pre><ul>
<li>开始编写 C/C++代码之前我们需要两个头文件。其中一个是 jni.h，该头文件包含了对jni数据类型和接口的定义（之后还会介绍），现在开始你所编写的所有C/C++代码都需要引入这个头文件。另外你还需要一个根据刚刚编写的native方法签名及类信息生成的头文件。对前者，简单地include进来即可，而对于后者，可以使用javah命令生成，当然你也可以选择亲自编写，使用命令生成的方法如下</li>
</ul>
<pre><code>//在终端中
cd app/src/main/java
javac com/linjiamin/jnishare/JniUtil.java
javah com.linjiamin.jnishare.JniUtil

//生成的头文件如下

/* DO NOT EDIT THIS FILE - it is machine generated */
#include &lt;jni.h&gt;
/* Header for class com_linjiamin_jnishare_JniUtil */

#ifndef _Included_com_linjiamin_jnishare_JniUtil
#define _Included_com_linjiamin_jnishare_JniUtil
#ifdef __cplusplus
extern &quot;C&quot; {
#endif
/*
* Class:     com_linjiamin_jnishare_JniUtil
* Method:    sum
* Signature: (II)I
*/
JNIEXPORT jint JNICALL Java_com_linjiamin_jnishare_JniUtil_sum 
(JNIEnv *, jclass, jint, jint);

#ifdef __cplusplus
}
#endif
#endif
</code></pre><ul>
<li>简单说一下如何手写这个头文件，预处理指令的写法都是相同的，将完整类名替换进去即可，对于函数签名，从左到右按以下顺序编写，当然还是使用javah方法生成更好</li>
</ul>
<pre><code>JNIEXPORT： 在android和linux中是空定义的宏，而在windows下被定义为__declspec(dllexport)，具体的作用我们不需要关心

jni数据类型：如jint，jboolean，jstring，它们对应于本地方法的返回类型（int，boolean，String）之后会进一步介绍、

JNICALL ： 这是__stdcall等函数调用约定（calling conventions）的宏，这些宏用于提示编译器该函数的参数如何入栈（从左到右，从右到左），以及清理堆栈的方式等

方法名： Java + 完整类名 + 方法名

参数列表：JNIEnv * + jclass\jobject + 所有你定义的参数所对应的jni数据类型 ，JNIEnv*是指向jvm函数表的指针，如果该方法为静态方法则第二个参数为class否则为jobject，它是含有该方法的class对象或实例

注意JNIEXPORT和JNICALL是固定的
</code></pre><ul>
<li>函数具体实现如下，相信大家都能看懂</li>
</ul>
<pre><code>#include &quot;jni.h&quot;
#include &quot;com_linjiamin_jnishare_JniUtil.h&quot;
//
// Created by Albert Humbert on 17/11/17.
//

JNIEXPORT jint JNICALL Java_com_linjiamin_jnishare_JniUtil_sum
(JNIEnv * env, jclass obj, jint num1, jint num2){
  return num1 + num2;
}
</code></pre><p><br>       </p>
<h4 id="2-使用ndk编译so包"><a href="#2-使用ndk编译so包" class="headerlink" title="2.使用ndk编译so包"></a>2.使用ndk编译so包</h4><p><br>   </p>
<h5 id="包结构"><a href="#包结构" class="headerlink" title="包结构"></a>包结构</h5><ul>
<li>现在在main包下创建一个jni包，将你的头文件和c/c++文件放进去，然后，你还需要两份mk文件，mk文件是makefile文件的一部分，makefile包含c/c++编译器的编译命令、顺序和规则，如果你不了解makefile是什么，那也没什么关系，后面会讲解Android.mk和Application.mk文件的书写规范</li>
</ul>
<ul>
<li>注意请在Android Library中进行ndk开发，不要使用Java Library，前者会生成aar包，可以包含so以及其他资源文件，后者会生成jar，jar通常只能调用外部so包，网上也有文章将jar当中的so包用文件流写到本地调用的，建议不要尝试这种骚操作</li>
</ul>
<p><br>       </p>
<h5 id="编写Android-mk"><a href="#编写Android-mk" class="headerlink" title="编写Android.mk"></a>编写Android.mk</h5><ul>
<li>你可以直接登录 <a href="http://android.mk" target="_blank" rel="external">http://android.mk</a> ，查看相关文档</li>
</ul>
<ul>
<li>一个最基本的Android.mk如下</li>
</ul>
<pre><code>LOCAL_PATH := $(call my-dir)
include $(CLEAR_VARS)
LOCAL_MODULE := libsotest
LOCAL_SRC_FILES := com_linjiamin_jnishare_JniUtil.cpp
include $(BUILD_SHARED_LIBRARY)
</code></pre><ul>
<li>LOCAL_PATH := $(call my-dir)，Android.mk必须以该属性开头，它用于指定源文件的路径，my-dir是一个返回Android.mk文件所在目录的宏</li>
</ul>
<ul>
<li>include $(CLEAR_VARS) ，指定负责文件的清理的makefile文件，一般固定这么写就好</li>
</ul>
<ul>
<li>LOCAL_SRC_FILES，需要编译的c/c++文件，如无后缀则默认为cpp文件</li>
</ul>
<ul>
<li>include $(BUILD_SHARED_LIBRARY) ，收集上次清理后的源文件信息，并决定如何编译</li>
</ul>
<ul>
<li>LOCAL_C_INCLUDES，头文件的搜索路径</li>
</ul>
<ul>
<li>TARGET_ARCH，指定CPU，如armeabi，armeabi-v7a</li>
</ul>
<p><br>       </p>
<h5 id="编写Application-mk"><a href="#编写Application-mk" class="headerlink" title="编写Application.mk"></a>编写Application.mk</h5><ul>
<li>一个典型的Application.mk文件如下</li>
</ul>
<pre><code>APP_PLATFORM = android-24
APP_ABI := armeabi,armeabi-v7a,x86_64,arm64-v8a
APP_STL := stlport_static
APP_OPTIM := debug
</code></pre><ul>
<li>APP_PLATFORM，ndk版本号，你可以在ndk-bundle文件夹中查看所本地ndk版本</li>
</ul>
<pre><code># for mac
/Users/alberthumbert/Library/Android/sdk/ndk-bundle/platforms
</code></pre><ul>
<li>APP_ABI，指定APP_ABI版本，这会决定ndk编译出的so包数量，关于ABI的介绍见下文，推荐至少包含armeabi或armeabi-v7a</li>
</ul>
<ul>
<li>APP_STL 如何连接c++标准库 ，包括 stlport_static ，stlport_shared ，system，分别表示静态，动态，系统默认</li>
</ul>
<ul>
<li>APP_OPTIM，包括debug，和release，这会决定so中是否包含调试信息</li>
</ul>
<ul>
<li>APP_MODULES，填写so包的名字，如果没有这个属性，则按照Android.mk中的进行命名，注意如果文件中含有多个该属性，则会按照先后顺序为你编译出来的so文件命名</li>
</ul>
<ul>
<li>填写完这两个mk文件之后，需要在gradle中指定so库的路径，gradle会自动将so文件打包进来，在andorid闭包中添加</li>
</ul>
<pre><code>sourceSets.main {
jniLibs.srcDir &apos;src/main/libs&apos;
jni.srcDirs = []
}
</code></pre><ul>
<li>如无意外这个时候我们的项目就可以运行起来了，打印log如下</li>
</ul>
<pre><code>11-17 16:33:37.563 3824-3824/? D/JniUtil: test: 2
</code></pre><p><br></p>
<h3 id="人生苦短，我用AS-3-0"><a href="#人生苦短，我用AS-3-0" class="headerlink" title="人生苦短，我用AS 3.0"></a>人生苦短，我用AS 3.0</h3><p><br></p>
<h4 id="自动生成函数"><a href="#自动生成函数" class="headerlink" title="自动生成函数"></a>自动生成函数</h4><ul>
<li>如果出于不幸、粗心、经验不足等原因，你的项目无法运行，请不要怀疑你的智商，下面为你带来傻瓜式的ndk开发流程</li>
</ul>
<ul>
<li>最新版的AS，可以为你使用ndk开发提供很大的方便，请确保你在SDK Tools中下载了CMake、LLDB、NDK</li>
</ul>
<ul>
<li>首先创建一个新项目，并勾选Include C++ support</li>
</ul>
<ul>
<li>C++ Standard中可以选择使用的C++标准，默认是CMake所使用的标准，Exceptions Support可以启用C++异常处理，一般这些选项使用默认的就可以了</li>
</ul>
<ul>
<li>项目创建完毕之后你可以看见官方已经为你做好了很多工作，并且带了一个c++的hello world示例，你需要关注的主要有cpp和External Build Files 两个目录，前者用于放置你的C++源文件，后者根据不同的ABI版本放置了CMake脚本</li>
</ul>
<ul>
<li>接着我们直接在MainActivity中添加一个native方法，然后选中该方法，按下alt+enter，让IDE为我们自动生成C++函数</li>
</ul>
<pre><code>public native boolean booleanFromJNI();
</code></pre><ul>
<li>在native-lib.cpp中可以看见自动生成的函数，我们只需要实现该函数即可</li>
</ul>
<pre><code>JNIEXPORT jboolean JNICALL
Java_com_linjiamin_myapplication_MainActivity_booleanFromJNI(JNIEnv *env, jobject instance) {

    // TODO

}
</code></pre><ul>
<li>注意使用上面的方法你可以在任意一个java文件中声明native方法，IDE会自动在native-lib.cpp中为你生成对应的函数签名，当然，你也不是非要把所有的C/C++代码都写在一个文件里，下面来讲解一下CMakeList的基本写法</li>
</ul>
<p><br></p>
<h4 id="编写CMakeList"><a href="#编写CMakeList" class="headerlink" title="编写CMakeList"></a>编写CMakeList</h4><ul>
<li>下面是一份官方写好的CMakeList.txt，这个文件可以在你当前项目的app目录下看到</li>
</ul>
<pre><code>add_library( # 设置编译出来的so包的名字. 不需要添加lib前缀
             native-lib

             # 设置为共享链接库. 有SHARED，STATIC两种可选
             SHARED

             # 设置源文件的相对路径，可将多个源文件进行编译
             src/main/cpp/native-lib.cpp )

# Searches for a specified prebuilt library and stores the path as a
# variable. Because CMake includes system libraries in the search path by
# default, you only need to specify the name of the public NDK library
# you want to add. CMake verifies that the library exists before
# completing its build.

find_library( # 设置外部引用库.这个库支持你在c/c++中打印log，具体请见  android/log.h
            log-lib
            # 外部引用库的名称
            log )

# Specifies libraries CMake should link to your target library. You
# can link multiple libraries, such as libraries you define in this
# build script, prebuilt third-party libraries, or system libraries.

target_link_libraries( # 指定被链接的库.
                    native-lib

                    # 链接log-lib到native-lib
                    ${log-lib} )
</code></pre><ul>
<li>现在我们想要将不同的源文件编译成多份so包，例如我在cpp目录下添加一份test-lib.cpp文件，代码如下</li>
</ul>
<pre><code>extern &quot;C&quot;
JNIEXPORT jboolean JNICALL
Java_com_linjiamin_myapplication_JniUtil_booleanFromJNI(JNIEnv *env, jobject instance) {

//上面提到的log库可以这么使用，而且你应该使用宏让它好看些
__android_log_print(ANDROID_LOG_DEBUG,&quot;stringFromJNI&quot;,&quot;%d&quot;,0);
return (jboolean) true;

}
</code></pre><ul>
<li>那么可以在刚刚的CMakeList中设定我们的so包，在最后加上</li>
</ul>
<pre><code>add_library( test-lib SHARED src/main/cpp/test-lib.cpp )
</code></pre><ul>
<li>编译之后 可以看到 build/intermediates/cmake/debug/obj/ 路径下不同的ABI目录中都有了两份so文件，分别是libnative-lib.so，libtest-lib.so</li>
</ul>
<ul>
<li>如果你在不同的路径下放置了源文件，并且希望对于每一个特定的路径都有一份自己特定的CMakeList文件来描述这些源文件的打包规则（这看起来是个好习惯），可以使用add_subdirectory(“目录名”)方法指定子路径，子路径当中的放置CMakeList会被执行</li>
</ul>
<p><br></p>
<h3 id="使用g-编译so包"><a href="#使用g-编译so包" class="headerlink" title="使用g++编译so包"></a>使用g++编译so包</h3><ul>
<li>对于非安卓开发者，这里再简单介绍一个使用g++编译so包的方法，使用这种方法你无需ndk环境，也不用编写mk、CMakeList文件，完全使用命令行进行编译，当然我更推荐你去学习cmake</li>
</ul>
<ul>
<li>编写java文件并用javah指令生成头文件，再编写cpp文件，这个流程对于不同平台的jni开发都是相同的（虽然Intelligent Idea这种IDE可以为你自动生成头文件），那么现在需要一份对应平台下的jni.h文件，可以在你的jdk当中查找，编译器可能还会提示你需要一份jni_md.h文件，它也在jdk当中</li>
</ul>
<pre><code>$ cd /Library/Java/JavaVirtualMachines/jdk1.7.0_71.jdk
$ find . -iname jni.h
./Contents/Home/include/jni.h
</code></pre><ul>
<li>我这里用的是ndk当中的jni.h文件，下载ndk之后在sdk当中可以找到</li>
</ul>
<pre><code>$ cd /Users/alberthumbert/Library/Android/sdk/ndk-bundle
$ find . -iname jni.h
./sysroot/usr/include/jni.h
</code></pre><ul>
<li>现在假定你以及有了一份java文件，两份头文件，一份cpp或c文件，那么可以使用如下命令将他们编译成so文件，注意最后的参数不一定是必要的，如果你想编译安卓平台可用的so包那么建议加上</li>
</ul>
<pre><code>g++ com_linjiamin_jnishare_JniUtil.cpp -fPIC -shared -o libsotest.so -Wl,--hash-style=sysv
</code></pre><p>*<em>注意，</em>nix平台使用lib表示一个so库，所以so文件必须以lib开头，但加载时请将lib前缀去掉**</p>
<ul>
<li>你可以用绝对路径加载一个so文件</li>
</ul>
<pre><code>System.load(&quot;\***\***\***.so&quot;)
</code></pre><ul>
<li>你也可以将so文件放入系统加载路径当中，调用  System.getProperty(“java.library.path”)方法得到系统加载路径，想要修改这个路径，可以在修改.bashrc（或者当前使用的其他shell）中添加</li>
</ul>
<pre><code>export PATH=PATH:/XXX
</code></pre><ul>
<li>运行jar时动态指定路径也是可以的，这样会暂时覆盖上面写入的属性</li>
</ul>
<pre><code>java -jar -Djava.library.path=/**/**   **.jar
</code></pre><ul>
<li>重新在java代码中加载so文件，*nix平台注意去掉lib前缀</li>
</ul>
<pre><code>System.loadLibrary (&quot;***&quot;);
</code></pre><p><br></p>
<h3 id="ABI与so"><a href="#ABI与so" class="headerlink" title="ABI与so"></a>ABI与so</h3><ul>
<li>这里再啰嗦一下别的东西，可以先跳过，之后再倒回来看</li>
</ul>
<ul>
<li>由于目前我们的项目很简单，没有用到第三方so库和也没有去除多余so库为apk瘦身，因此不用考虑兼容问题，但实际开发项目时通常没这么简单。我们知道，编译出来的so是二进制文件，由于不同的CPU支持不同的指令集，所以我们需要考虑兼容性的问题。一个包含多种指令集及其相关约定的实现被称之为ABI，一个CPU架构支持一种到多种ABI。安卓平台就是针对ABI进行编译和打包的。</li>
</ul>
<ul>
<li>可能看了上面这一段会比较晕，那么我就举一个例子来说明，比如ARMv7架构的CUP，支持 armeabi和armeabi-v7a两种ABI，而armeabi这种ABI支持Thumb-1，ARMV5TE等指令集，armeabi-v7a这种ABI又支持Thumb-2和VFPv3-D16等指令集，也就是说，一种CPU架构对应多种ABI类型，一种ABI类型对于多种指令集</li>
<li>一个so文件只支持一种ABI，因此你会发现在lib下每一个包都是以ABI来命名的，同名的so文件被按照其支持的ABI进行分类</li>
<li>目前ABI一共有七种，那么是不是意味者我们的每一个so都需要编译成七种，然后全都打包进apk当中呢，答案是否定的。目前CUP流行的架构主要有ARM系列，x86，x86_64，而这些架构全部都支持armeabi这种ABI，因此类似淘宝、微信、饿了么的国内大厂通常只使用armeabi一种ABI，Facebook，Twitter等外国大厂则是只保留了armeabi-v7a，这是十分合理的，apk只保留一种通用的ABI，而最适应的so可以在外部去下载</li>
</ul>
<ul>
<li>那么是不是只要编译一种so文件就可以了呢？不完全正确，如果你引用了第三方的ndk，而第三方在兼容性做得比较好的情况下适配了多种ABI，又或者目前你的lib下so包的数量参差不齐。当一个apk安装时就有可能查找到了最适用的ABI的路径存在，但里面又没有想要的so，这时它不会自动去查找其他ABI版本的so，而是会crash，为了解决这个问题，请在lib包下只保留一个包（通常是armeabi或者armeabi-v7a），或者每个名字的so在不同包下都存在对应版本，并且在app的gradle的defaultConfig闭包中添加你所适配好的ABI，这样安装时只会从你所指定的ABI中查找so包</li>
</ul>
<pre><code>ndk{
    abiFilters  &quot;armeabi-v7a&quot;, &quot;x86&quot;, &quot;armeabi&quot;
}
</code></pre><p><br></p>
<h2 id="什么是jni"><a href="#什么是jni" class="headerlink" title="什么是jni"></a>什么是jni</h2><p><strong>现在我们已经可以进行简单的ndk开发了，但为了加深理解认识，让我再来啰嗦一下jni</strong></p>
<p><strong>看过这一部分之后你对jni应该会有更近一步的感性认识</strong></p>
<p><br></p>
<h2 id="jni-h"><a href="#jni-h" class="headerlink" title="jni.h"></a>jni.h</h2><p><br></p>
<h3 id="jni数据类型"><a href="#jni数据类型" class="headerlink" title="jni数据类型"></a>jni数据类型</h3><ul>
<li>现在来看看c/c++层的数据类型是怎么对应到java层的</li>
</ul>
<ul>
<li>首先是基本类型，根据java中的定义定义了j*类型</li>
</ul>
<pre><code>/* Primitive types that match up with Java equivalents. */
typedef uint8_t  jboolean; /* unsigned 8 bits */
typedef int8_t   jbyte;    /* signed 8 bits */
typedef uint16_t jchar;    /* unsigned 16 bits */
typedef int16_t  jshort;   /* signed 16 bits */
typedef int32_t  jint;     /* signed 32 bits */
typedef int64_t  jlong;    /* signed 64 bits */
typedef float    jfloat;   /* 32-bit IEEE 754 */
typedef double   jdouble;  /* 64-bit IEEE 754 */
</code></pre><ul>
<li>对于引用类型，c和c++有区别，在c++中 jobject是类，而jstring和各种类型的数组都是jobject的子类的指针，在c中jobject是一个void*指针，而其他引用类型其实都是jobject</li>
</ul>
<pre><code>class _jobject {};
class _jclass : public _jobject {};
class _jstring : public _jobject {};
class _jarray : public _jobject {};
class _jobjectArray : public _jarray {};
class _jbooleanArray : public _jarray {};
class _jbyteArray : public _jarray {};
class _jcharArray : public _jarray {};
class _jshortArray : public _jarray {};
class _jintArray : public _jarray {};
class _jlongArray : public _jarray {};
class _jfloatArray : public _jarray {};
class _jdoubleArray : public _jarray {};
class _jthrowable : public _jobject {};

typedef _jobject*       jobject;
typedef _jclass*        jclass;
typedef _jstring*       jstring;
typedef _jarray*        jarray;
typedef _jobjectArray*  jobjectArray;
typedef _jbooleanArray* jbooleanArray;
typedef _jbyteArray*    jbyteArray;
typedef _jcharArray*    jcharArray;
typedef _jshortArray*   jshortArray;
typedef _jintArray*     jintArray;
typedef _jlongArray*    jlongArray;
typedef _jfloatArray*   jfloatArray;
typedef _jdoubleArray*  jdoubleArray;
typedef _jthrowable*    jthrowable;
typedef _jobject*       jweak;


/*
 * Reference types, in C.
 */
typedef void*           jobject;
typedef jobject         jclass;
typedef jobject         jstring;
typedef jobject         jarray;
typedef jarray          jobjectArray;
typedef jarray          jbooleanArray;
typedef jarray          jbyteArray;
typedef jarray          jcharArray;
typedef jarray          jshortArray;
typedef jarray          jintArray;
typedef jarray          jlongArray;
typedef jarray          jfloatArray;
typedef jarray          jdoubleArray;
typedef jobject         jthrowable;
typedef jobject         jweak;
</code></pre><ul>
<li>jvalue是一个比较特殊的联合体，一般在需要调用java层方法时做为方法参数传入，如 void CallVoidMethodA(jobject obj, jmethodID methodID, jvalue* args) ，通过jobject和表示其方法的jmethodID即可特定一个具体的方法，然后将我们的jvalue作为函数列表传入</li>
</ul>
<pre><code>typedef union jvalue {
        jboolean    z;
        jbyte       b;
        jchar       c;
        jshort      s;
        jint        i;
        jlong       j;
        jfloat      f;
        jdouble     d;
        jobject     l;
    } jvalue;
</code></pre><ul>
<li>在这一方面我们可以讨论的内容比较少，总的来说，由于C/C++ 中基本类型的字节数依赖与实现，所以在native层转换到java层是不能直接使用原本的int，long等类型而是根据java中的约定使用jni.h指定了相同长度与有符号的类型，而java中的类则可以使用类或结构体的指针来解决</li>
</ul>
<p><br></p>
<h3 id="常用的接口"><a href="#常用的接口" class="headerlink" title="常用的接口"></a>常用的接口</h3><p><strong>在讲解JNIEnv和JavaVM之前先来尝试一下各种jni的基本操作，版本较新的AS已经支持了对C/C++ 的智能提示和代码补全功能，你可以很方便地试用JNIEnv提供的接口</strong></p>
<p><strong>这里只介绍几个例子，以后有时间我会另写文章介绍这些接口，强烈推荐你使用AS把可调用的函数浏览并选择性地使用一遍</strong></p>
<p><br></p>
<h4 id="修改成员变量"><a href="#修改成员变量" class="headerlink" title="修改成员变量"></a>修改成员变量</h4><ul>
<li>通过之前的例子你应该已经知道怎么从native层中获取一个变量了，现在再进一步，我们使用native方法直接改变成员变量的值，在MainActivity中定义一个native方法</li>
</ul>
<pre><code>public class MainActivity extends AppCompatActivity {

    public String mString = null;

static {
        System.loadLibrary(&quot;native-lib&quot;);
    }

    private static final String TAG = &quot;MainActivity&quot;;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        Log.d(TAG, &quot;onCreate: &quot;+mString);
        getFieldFromJNI();
        Log.d(TAG, &quot;onCreate: &quot;+ mString);
    }

    public native String getFieldFromJNI();

}
</code></pre><ul>
<li>在来看C++实现，注意你可能在阅览其他文章时发现调用jni函数时有两种不同的写法 env-> 和 (*env)->，这是由于C与C++的实现有所差异，不影响我们使用。如果你使用过反射改变成员变量的值，应该可以毫不费力地理解下面这段代码</li>
</ul>
<pre><code>extern &quot;C&quot;
JNIEXPORT jstring JNICALL
Java_com_linjiamin_jnilearning_MainActivity_getFieldFromJNI(JNIEnv *env, jobject instance) {

    jclass clazz = env-&gt;GetObjectClass(instance);
    //获取调用者的class对象
    jfieldID  jfID = env -&gt;GetFieldID(clazz,&quot;mString&quot;,&quot;Ljava/lang/String;&quot;);
    //获取成员变量的键
    jstring strValue = (jstring) env-&gt;GetObjectField(instance, jfID);
    //获取成员变量的值，不做操作
    char chars[10] = &quot;whatever&quot;；
    jstring newValue = env-&gt;NewStringUTF(chars);
    //创建一个String对象
    env-&gt;SetObjectField(instance,jfID,newValue);
    //设置新的值
    return strValue;
}
</code></pre><p><br></p>
<h4 id="创建引用"><a href="#创建引用" class="headerlink" title="创建引用"></a>创建引用</h4><p><br></p>
<h5 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h5><ul>
<li>了解jni中的引用类型，有助于你编写高效的代码并且解决内存泄漏等问题，jni中的引用类型可以分为三种，局部引用，全局引用，弱（全局）引用，通常jvm会在函数返回后自动为你释放局部引用，但你需要自行管理全局引用的生命周期</li>
</ul>
<p><br></p>
<h5 id="局部引用"><a href="#局部引用" class="headerlink" title="局部引用"></a>局部引用</h5><ul>
<li>其实我们之前已经接触过局部引用了，调用jni函数通常会创建新对象的实例并返回一个局部引用，局部引用只在一次native函数的调用周期中存在，在函数结束时被释放</li>
</ul>
<ul>
<li>通常我们需要避免返回全局引用，而是返回创建出来的局部引用，例如这样</li>
</ul>
<pre><code>return (jstring) env-&gt;NewLocalRef(someValue);
</code></pre><ul>
<li>我们刚刚说过，局部引用在函数的调用过程中存在，也就是说如果不进行人为的销毁操作，它将一直存在，在任意native函数中执行下面这段代码，你将接受到一个异常，跟java不同，gc不会及时回收通过这种方法创建出来的变量</li>
</ul>
<pre><code>for(int i = 0;i&lt;1000000000;i++){
    jstring newValue = env-&gt;NewStringUTF(chars);
}
</code></pre><ul>
<li>你可以调用 DeleteLocalRef函数销毁一个局部引用，这个函数现在就可以执行了，不过他会比一般函数耗时些</li>
</ul>
<pre><code>for(int i = 0;i&lt;1000000000;i++){
    jstring newValue = env-&gt;NewStringUTF(chars);
    env-&gt;DeleteLocalRef(newValue);
}
</code></pre><p><br></p>
<h5 id="全局引用"><a href="#全局引用" class="headerlink" title="全局引用"></a>全局引用</h5><ul>
<li>之前说过局部引用在函数的调用过程中存在，我们不能直接使用显式赋值的方式将局部引用强行将其缓存起来</li>
</ul>
<pre><code>jobject gInstance;

…

extern &quot;C&quot; JNIEXPORT void JNICALL 
Java_com_linjiamin_jnilearning_MainActivity_useCPlusThread(JNIEnv *env, jobject instance) {
methodID = env-&gt;GetMethodID(clazz,&quot;sayHello&quot;,&quot;()V&quot;);
gInstance = instance;
...
}
</code></pre><ul>
<li>上面的例子将会报错，不过对于jni开发，你可能常常只能收到含糊的报错信息，甚至收不到报错信息</li>
</ul>
<pre><code>JNI DETECTED ERROR IN APPLICATION: native code passing in reference to invalid stack indirect reference table or invalid reference: 0x7fff871642e0
</code></pre><ul>
<li>我们可以使用 NewGlobalRef 函数来创建一个全局引用，但是注意，你需要对自己的行为负责，全局引用只有在你的手动调用 DeleteGlobalRef 函数之后才会被释放，你可以在JNI_OnLoad 中进行缓存工作，在JNI_OnUnload函数中进行缓存的清除</li>
</ul>
<pre><code>jobject gInstance;

…
extern &quot;C&quot; JNIEXPORT void JNICALL 
Java_com_linjiamin_jnilearning_MainActivity_useCPlusThread(JNIEnv *env, jobject instance) {

methodID = env-&gt;GetMethodID(clazz,&quot;sayHello&quot;,&quot;()V&quot;);
gInstance = env-&gt;NewGlobalRef(instance);
...
}

…

void fun() {
...
...
env-&gt;DeleteGlobalRef(gInstance);
}
</code></pre><p><br></p>
<h5 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h5><ul>
<li>弱引用和全局引用大体上类似，但是当内存不足时它会被GC回收，通过 NewWeakGlobalRef 函数可以创建一个弱引用，和Java层的弱引用一致，它不会阻止自己所指向的对象被GC回收</li>
</ul>
<pre><code>gInstance = env-&gt;NewWeakGlobalRef(instance);
</code></pre><ul>
<li>但是这不意味着你可以不用管理弱引用的生命周期，在不需要它时请主动释放弱引用，注意，弱引用的释放不会导致它所指向的对象被GC回收</li>
</ul>
<pre><code>env-&gt;DeleteWeakGlobalRef(gInstance)
</code></pre><ul>
<li>最好在使用弱引用时判断它的对象是否已被释放，你可能会理所当然地使用 == 进行判断，这种方法是错误的，除非这个引用从来就没有被初始化过，不然表达式将永远为真，解决方案是使用jni提供的接口进行比较，有的文章也推荐再次使用NewWeakGlobalRef来达到这样的效果，个人认为这两种方案除了在可读性上的区别外没什么不同</li>
</ul>
<pre><code>if (env-&gt;IsSameObject(gInstance,NULL)) {
    __android_log_print(ANDROID_LOG_DEBUG,&quot;fun&quot;,&quot;%s&quot;,&quot;instance is NULL&quot;);
}

    //或者

if (!gInstance || !env-&gt;NewWeakGlobalRef(gInstance)) {
    __android_log_print(ANDROID_LOG_DEBUG,&quot;fun&quot;,&quot;%s&quot;,&quot;instance is NULL&quot;);
}
</code></pre><p><br></p>
<h4 id="JNIEnv，JavaVM-以及多线程"><a href="#JNIEnv，JavaVM-以及多线程" class="headerlink" title="JNIEnv，JavaVM 以及多线程"></a>JNIEnv，JavaVM 以及多线程</h4><ul>
<li>你可能已经意识到，目前为止我们都是通过JNIEnv来使用jni的，实际上JNIEnv提供了Native函数的基础环境，具体来说，它包含了一个指向函数表的指针，这也就是为什么我们需要通过JNIEnv才能调用native方法，JNIEnv也代表了具体的进程环境，因此不允许跨进程调用，最好的做法是永远不要缓存JNIEnv，你可以通过JavaVM来创造它的实例</li>
</ul>
<p><img src="https://s1.ax1x.com/2017/11/22/2xj2T.png" alt="" title="JNIEnv"></p>
<ul>
<li>JavaVM是java虚拟机的代表，它可以跨线程调用，它是一个全局对象，典型的jni环境中一个进程可以有多个JavaVM,但是在安卓环境当中他在每个进程中只有一个实例，通常你可以在JNI_OnLoad 函数，或其可以获取JNIEnv的地方得到它_</li>
</ul>
<pre><code>env-&gt;GetJavaVM(&amp;gVm);
</code></pre><ul>
<li>下面在C++线程中模仿耗时操作，并调用Java层方法传回数据，首先定义接受数据的方法和一个native方法，这里的参数列表稍微定义得复杂一点，方便之后演示jvalue的使用方法</li>
</ul>
<pre><code>public void resultCallback(boolean isSuccess,int result,String data){
    Log.d(TAG, &quot;resultCallback: &quot;+ isSuccess + &quot; &quot;+result + &quot; &quot; +data);
}

public native void useCPlusThread();
</code></pre><ul>
<li>native方法的实现如下,这里我们通过GetJavaVM方法得到了JavaVM对象，JavaVM用于我们之后获取JNIEnv，同时我们把调用者通过全局引用缓存起来，注意这里的methodID不需要使用NewGlobalRef，它是一个结构体，直接赋值即可，由于java支持重载，需要输入方法函数列表的标识才可以特定一个方法，每个基本类型都有其对应的缩写，而对于类我们需要通过包名和类名来指定。然后我们开启五个线程进行耗时操作</li>
</ul>
<pre><code>extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_linjiamin_jnilearning_MainActivity_useCPlusThread(JNIEnv *env, jobject instance) {

env-&gt;GetJavaVM(&amp;gVm);
jclass clazz = env-&gt;GetObjectClass(instance);


methodID = env-&gt;GetMethodID(clazz, &quot;resultCallback&quot;, &quot;(ZILjava/lang/String;)V&quot;);
gInstance = env-&gt;NewGlobalRef(instance);

pthread_t pthread[5];

for(int i = 0;i&lt;5;i++){
    pthread_create(&amp;pthread[i], NULL, &amp;fun, NULL);
}
}
</code></pre><ul>
<li>线程方法的实现如下,linux系统的sleep函数定义在unistd.h文件中，我们使用它来模仿耗时操作，像刚刚说过的一样JNIEnv不能跨进程调用，那么这里使用AttachCurrentThread函数得到实例，这个函数同时也会将当前线程绑定到JavaVM上，然后我们使用CallVoidMethodA来调用刚刚缓存起来的实例的方法，也就是java层的resultCallback方法，jvalue数组可以作为参数列表传入，另外你也可以使用更为简便的CallVoidMethod函数，最后记得使用DetachCurrentThread函数解绑，除非你使用DeleteLocalRef函数释放引用，不然你通过JNIEnv获取的局部引用在你调用DetachCurrentThread之前都不会被销毁，并且在函数结束后造成内存泄漏</li>
</ul>
<pre><code>void *fun(void *arg) {
sleep(3);

JNIEnv *env;
if (gVm-&gt;AttachCurrentThread(&amp;env, NULL) != JNI_OK) {
    __android_log_print(ANDROID_LOG_DEBUG, &quot;callJniInDifferentThread&quot;, &quot;%s&quot;, &quot;attach failed&quot;);
    return NULL;
}

jvalue * args = new jvalue[3];
args[0].z = (jboolean) true;
args[1].i = 1000;
args[2].l = env-&gt;NewStringUTF(&quot;some data&quot;);

env-&gt;CallVoidMethodA(gInstance, methodID, args);

if (gVm-&gt;DetachCurrentThread() != JNI_OK) {
    __android_log_print(ANDROID_LOG_DEBUG, &quot;callJniInDifferentThread&quot;, &quot;%s&quot;, &quot;detach failed&quot;);
}

return NULL;

}
</code></pre><ul>
<li>注，各种类型对应的缩写如下，请使用一下的缩写特定具体的方法</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>缩写       </th>
</tr>
</thead>
<tbody>
<tr>
<td>Boolean</td>
<td>Z</td>
</tr>
<tr>
<td>Byte</td>
<td>B</td>
</tr>
<tr>
<td>Char</td>
<td>C</td>
</tr>
<tr>
<td>Short</td>
<td>S</td>
</tr>
<tr>
<td>Int</td>
<td>I</td>
</tr>
<tr>
<td>Long</td>
<td>L</td>
</tr>
<tr>
<td>Float</td>
<td>F</td>
</tr>
<tr>
<td>Double</td>
<td>D</td>
</tr>
<tr>
<td>Void</td>
<td>V</td>
</tr>
<tr>
<td>Object</td>
<td>以”L”开头，以”;”结尾，中间是用”/“ 隔开的包及类名。比如：Ljava/lang/String;如果是嵌套类，则用$来表示嵌套。例如 “(Ljava/lang/String;Landroid/os/FileUtils$FileStatus;)Z”</td>
</tr>
<tr>
<td>返回值与参数</td>
<td>例 (IB)L 表示返回类型为long，参数为int和byte的函数</td>
</tr>
</tbody>
</table>
<p><br></p>
<h2 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h2><p><br></p>
<h3 id="局部引用的内存模型"><a href="#局部引用的内存模型" class="headerlink" title="局部引用的内存模型"></a>局部引用的内存模型</h3><ul>
<li>刚刚提到JVM在一定程度上会为你管理局部引用的生命周期，但这不意味着局部引用等于局部变量。每当线程从Java层切换到native层时，JVM会创建局部引用表，它们维系了你的C/C++变量和Java层变量。</li>
</ul>
<ul>
<li>下图中出现的本地方法栈是和虚拟机栈类似的一种概念，但它用于运行native方法，注意，规范只约定了jni的操作和使用方法，对实现没有明确的要求，有些虚拟机会将虚拟机栈与本地方法栈合并实现，这里只大致地描绘本地方法栈的结构。当java层切入到native层（以下简称J2N过程，反之为N2J），或者在native函数中调用了jni接口时会导致本地方法栈的入栈操作，本地引用表在J2N时创建，并在N2J时销毁，在这个过程中，每当局部引用被合法创建，该局部引用都会被添加到表中并映射到java堆中的一个对象</li>
</ul>
<p><img src="https://s1.ax1x.com/2017/11/22/2zSr4.png" alt="" title="NativeMethodStack"></p>
<ul>
<li>看回前面这个例子，我们在循环中不断创建新的局部引用，并且赋值给变量newValue，这些不断创建的引用并不会立即释放，并且我们之后也无法获取到这些还留在表中的引用，所以他们都导致了内存泄漏。一般情况下局部引用表分配到的内存空间很小，这种内存泄漏很容易就会导致内存溢出，虚拟机崩溃。为了编写更加安全流畅的代码，我建议你遵循下面几个规范</li>
</ul>
<pre><code>for(int i = 0;i&lt;1000000000;i++){
    jstring newValue = env-&gt;NewStringUTF(chars);
}
</code></pre><p><br></p>
<h3 id="引用的使用规范"><a href="#引用的使用规范" class="headerlink" title="引用的使用规范"></a>引用的使用规范</h3><ul>
<li>native编程首先需要遵循C/C++自身的内存管理机制，除了局部引用以外，JVM不会为你做更多的内存释放工作，所以当你使用malloc函数分配内存空间后必须使用free函数进行释放，这和其他平台上的C/C++编程没什么不同</li>
</ul>
<ul>
<li>全局变量对java层对象的引用一直有效，请在不用时进行删除，否它所指向的对象将一直留在堆中</li>
</ul>
<ul>
<li>和刚刚介绍局部引用时说的一样，在函数返回之前，局部引用不会自动释放，如果创建过多的引用将会导致内存溢出的风险，如果你的函数只会创建为数不多的局部引用，那么完全可以将删除引用的操作交给JVM去处理，但如果你的函数会创建大量的引用，特别是在开启循环的请况下，请自行调用DeleteLocalRef函数</li>
</ul>
<p><br></p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a href="https://www.ibm.com/Search/?q=jni&amp;v=18&amp;en=utf&amp;lang=zh&amp;cc=cn&amp;sn=dw&amp;dws=cndw&amp;hpp=20" target="_blank" rel="external">IBM developerWorks 相关文章</a></li>
<li><a href="https://www.zybuluo.com/cxm-2016/note/563686" target="_blank" rel="external">JNI 完全指南</a></li>
<li><a href="http://blog.csdn.net/a345017062/article/details/8068928" target="_blank" rel="external">JNI 官方规范中文版</a></li>
<li><a href="http://blog.csdn.net/guojin08/article/details/9964579" target="_blank" rel="external">Android JNI 编程提高篇</a></li>
<li><a href="http://blog.guorongfei.com/2017/01/24/android-jni-tips-md/" target="_blank" rel="external">Android JNI 使用总结</a></li>
</ul>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/12/09/makeFuckingGdalSo/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/10/23/RxJava/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.jpg);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Albert Humbert's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        709913148@qq.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/06/">六月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/05/">五月 2018<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/04/">四月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/03/">三月 2018<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/10/">十月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">24</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">3</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="关于我">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于我
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="标签索引">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                标签索引
            </a>
        </li>
        
    
        <li>
            <a href="/links" title="友情链接">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                友情链接
            </a>
        </li>
        
    
        <li>
            <a href="/whatever" title="Writers &amp; Weirdos">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                Writers &amp; Weirdos
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;2016&nbsp;-<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Albert's Blog
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
